name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-audit:
    runs-on: ubuntu-latest
    name: Security Audit and Vulnerability Assessment
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run npm audit
      run: |
        npm audit --audit-level=moderate || true
        npm audit --audit-level=high --json > audit-results.json || true
    
    - name: Security scan with enhanced validator
      run: |
        echo "üõ°Ô∏è Running comprehensive security validation..."
        npm run validate
    
    - name: Check for hardcoded secrets
      run: |
        echo "üîç Scanning for hardcoded secrets..."
        
        # Check for common secret patterns
        if grep -r "password\s*=\s*['\"][^'\"]\+['\"]" . --exclude-dir=node_modules --exclude-dir=.git; then
          echo "‚ùå Found hardcoded passwords"
          exit 1
        fi
        
        if grep -r "api[_-]\?key\s*=\s*['\"][^'\"]\+['\"]" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md"; then
          echo "‚ö†Ô∏è Found potential hardcoded API keys - review needed"
        fi
        
        if grep -r "secret\s*=\s*['\"][^'\"]\+['\"]" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md"; then
          echo "‚ö†Ô∏è Found potential hardcoded secrets - review needed"
        fi
        
        echo "‚úÖ Secret scanning completed"
    
    - name: Validate file permissions
      run: |
        echo "ÔøΩ Checking file permissions..."
        
        # Check for executable files that shouldn't be
        find . -name "*.md" -executable -not -path "./.git/*" -not -path "./node_modules/*" | while read file; do
          echo "‚ùå Markdown file should not be executable: $file"
          exit 1
        done
        
        # Check for world-writable files
        find . -type f -perm -002 -not -path "./.git/*" -not -path "./node_modules/*" | while read file; do
          echo "‚ùå File is world-writable: $file"
          exit 1
        done
        
        echo "‚úÖ File permissions are appropriate"
    
    - name: Dependency vulnerability check
      run: |
        echo "üì¶ Checking dependency vulnerabilities..."
        
        # Enhanced dependency checking
        if [ -f "audit-results.json" ]; then
          HIGH_VULNS=$(cat audit-results.json | grep -o '"severity":"high"' | wc -l)
          CRITICAL_VULNS=$(cat audit-results.json | grep -o '"severity":"critical"' | wc -l)
          
          echo "High severity vulnerabilities: $HIGH_VULNS"
          echo "Critical severity vulnerabilities: $CRITICAL_VULNS"
          
          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "‚ùå Critical vulnerabilities found - blocking deployment"
            exit 1
          fi
          
          if [ "$HIGH_VULNS" -gt 5 ]; then
            echo "‚ö†Ô∏è Too many high severity vulnerabilities"
            exit 1
          fi
        fi
        
        echo "‚úÖ Dependency security check passed"
    
    - name: Configuration security check
      run: |
        echo "‚öôÔ∏è Checking configuration security..."
        
        # Check for insecure configurations
        if find . -name "*.json" -not -path "./node_modules/*" -not -path "./.git/*" | xargs grep -l "\"password\":\|\"secret\":\|\"key\":"; then
          echo "‚ö†Ô∏è Found potential secrets in configuration files"
        fi
        
        # Check for debug flags in production configs
        if find . -name "*.json" -not -path "./node_modules/*" | xargs grep -l "\"debug\":\s*true"; then
          echo "‚ö†Ô∏è Found debug flags in configuration"
        fi
        
        echo "‚úÖ Configuration security check completed"
    
    - name: Generate security report
      if: always()
      run: |
        echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Hardcoded secret scanning completed" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ File permission validation passed" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Dependency vulnerability check completed" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Configuration security check completed" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "audit-results.json" ]; then
          echo "üìä **Dependency Audit Results**:" >> $GITHUB_STEP_SUMMARY
          echo "- High severity: $(cat audit-results.json | grep -o '"severity":"high"' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Critical severity: $(cat audit-results.json | grep -o '"severity":"critical"' | wc -l)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "üõ°Ô∏è Security scan completed successfully!" >> $GITHUB_STEP_SUMMARY

  markdown-security:
    runs-on: ubuntu-latest
    name: Markdown Content Security Review
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for malicious links
      run: |
        echo "ÔøΩ Scanning for potentially malicious links..."
        
        # Check for suspicious domains in markdown files
        SUSPICIOUS_PATTERNS="(bit\.ly|tinyurl\.com|t\.co|goo\.gl)|(javascript:|data:|vbscript:)"
        
        if grep -r -E "$SUSPICIOUS_PATTERNS" . --include="*.md" --exclude-dir=node_modules; then
          echo "‚ö†Ô∏è Found potentially suspicious links - manual review required"
        else
          echo "‚úÖ No suspicious links found"
        fi
    
    - name: Validate markdown structure
      run: |
        echo "üìù Validating markdown structure..."
        
        # Check for potentially dangerous HTML in markdown
        if grep -r "<script\|<iframe\|<object\|<embed" . --include="*.md" --exclude-dir=node_modules; then
          echo "‚ö†Ô∏è Found potentially dangerous HTML tags in markdown"
        else
          echo "‚úÖ No dangerous HTML tags found"
        fi
    
    - name: Content validation
      run: |
        echo "ÔøΩ Performing content validation..."
        
        # Check for TODO/FIXME in production files
        if find . -name "*.md" -not -path "./CONTRIBUTING.md" -not -path "./.github/*" | xargs grep -l "TODO\|FIXME\|XXX\|HACK"; then
          echo "‚ö†Ô∏è Found TODO/FIXME markers in production documentation"
        else
          echo "‚úÖ No TODO markers found in production files"
        fi

  compliance-check:
    runs-on: ubuntu-latest
    name: Compliance and Policy Validation
    
    steps:
    - uses: actions/checkout@v4
    
    - name: License compliance check
      run: |
        echo "‚öñÔ∏è Checking license compliance..."
        
        # Verify LICENSE file exists and is readable
        if [ ! -f "LICENSE" ]; then
          echo "‚ùå LICENSE file is missing"
          exit 1
        fi
        
        # Check for license headers in key files (if applicable)
        echo "‚úÖ License compliance check passed"
    
    - name: Documentation completeness
      run: |
        echo "ÔøΩ Checking documentation completeness..."
        
        REQUIRED_DOCS=("README.md" "CONTRIBUTING.md" "CHANGELOG.md")
        
        for doc in "${REQUIRED_DOCS[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "‚ùå Required documentation file missing: $doc"
            exit 1
          fi
        done
        
        echo "‚úÖ All required documentation files present"
    
    - name: Code of conduct check
      run: |
        echo "ü§ù Checking for code of conduct..."
        
        if [ -f "CODE_OF_CONDUCT.md" ] || grep -q "code of conduct" README.md CONTRIBUTING.md; then
          echo "‚úÖ Code of conduct found"
        else
          echo "‚ö†Ô∏è Consider adding a code of conduct"
        fi