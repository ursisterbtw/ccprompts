name: Validate Prompts and Commands

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'prompts/**/*.md'
      - '.claude/commands/**/*.md'
      - '.claude/workflows/**/*.yaml'
      - '.claude/config.json'
      - '.claude/mcp.json'

env:
  NODE_VERSION: '20'

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Content
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install validation tools
      run: |
        npm install -g markdownlint-cli markdown-link-check
        
    - name: Validate markdown files
      run: |
        # Lint markdown files
        markdownlint prompts/**/*.md .claude/commands/**/*.md README.md CLAUDE.md || true
        
        # Check for required XML sections in prompts
        for file in prompts/**/*.md; do
          if ! grep -q "<role>" "$file" || ! grep -q "<instructions>" "$file"; then
            echo "❌ $file missing required XML structure"
            exit 1
          fi
        done
        echo "✅ All prompts have valid XML structure"

    - name: Validate commands
      run: |
        # Check that all commands have proper headers and descriptions
        for file in .claude/commands/*.md; do
          if ! grep -q "^# " "$file" || ! grep -q "## Description" "$file"; then
            echo "❌ $file missing required sections"
            exit 1
          fi
        done
        echo "✅ All commands have valid structure"
        
        # Count commands
        command_count=$(ls -1 .claude/commands/*.md 2>/dev/null | wc -l)
        echo "Found $command_count commands"

    - name: Validate configuration files
      run: |
        # Validate JSON syntax
        node -e "JSON.parse(require('fs').readFileSync('.claude/config.json', 'utf8'))"
        node -e "JSON.parse(require('fs').readFileSync('.claude/mcp.json', 'utf8'))"
        echo "✅ Configuration files are valid JSON"
